{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Pomodoro Timer Card -->
            <div class="card shadow-lg">
                <div class="card-header bg-success text-white text-center">
                    <h3 class="mb-0"><i class="bi bi-stopwatch me-2"></i>Pomodoro Timer</h3>
                    <p class="mb-0">Stay focused with the Pomodoro Technique</p>
                </div>
                <div class="card-body text-center p-5">
                    <!-- Timer Display -->
                    <div class="timer-display mb-4">
                        <div class="timer-circle">
                            <svg width="300" height="300" class="timer-svg">
                                <circle cx="150" cy="150" r="140" stroke="#e9ecef" stroke-width="10" fill="none"/>
                                <circle id="progress-circle" cx="150" cy="150" r="140" stroke="#28a745" 
                                        stroke-width="10" fill="none" stroke-linecap="round"
                                        stroke-dasharray="879.6" stroke-dashoffset="879.6"/>
                            </svg>
                            <div class="timer-text">
                                <div id="timer-display" class="display-1 fw-bold text-success">25:00</div>
                                <div id="timer-status" class="h5 text-muted">Ready to Start</div>
                            </div>
                        </div>
                    </div>

                    <!-- Session Configuration -->
                    <div id="config-panel" class="mb-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Subject</label>
                                <select id="subject-select" class="form-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject }}">{{ subject }}</option>
                                    {% endfor %}
                                    <option value="custom">Custom Subject</option>
                                </select>
                                <input type="text" id="custom-subject" class="form-control mt-2" 
                                       placeholder="Enter custom subject" style="display: none;">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Work Duration</label>
                                <select id="work-duration" class="form-select">
                                    <option value="25">25 minutes (Classic)</option>
                                    <option value="30">30 minutes</option>
                                    <option value="45">45 minutes</option>
                                    <option value="60">60 minutes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="d-flex justify-content-center gap-3 mb-4">
                        <button id="start-btn" class="btn btn-success btn-lg px-4">
                            <i class="bi bi-play-fill me-2"></i>Start Session
                        </button>
                        <button id="pause-btn" class="btn btn-warning btn-lg px-4" style="display: none;">
                            <i class="bi bi-pause-fill me-2"></i>Pause
                        </button>
                        <button id="stop-btn" class="btn btn-danger btn-lg px-4" style="display: none;">
                            <i class="bi bi-stop-fill me-2"></i>Stop
                        </button>
                    </div>

                    <!-- Session Stats -->
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="stat-box">
                                <h4 id="cycles-completed" class="text-primary mb-0">0</h4>
                                <small class="text-muted">Cycles Today</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-box">
                                <h4 id="total-focus-time" class="text-success mb-0">0h</h4>
                                <small class="text-muted">Focus Time</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-box">
                                <h4 id="points-earned" class="text-warning mb-0">0</h4>
                                <small class="text-muted">Points Earned</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Session Completion Modal -->
            <div class="modal fade" id="sessionCompleteModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-check-circle me-2"></i>Session Complete!
                            </h5>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-4">
                                <i class="bi bi-trophy display-1 text-warning"></i>
                                <h4 class="mt-3">Great job! You completed a focus session.</h4>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">How was your focus? (1-10)</label>
                                <div class="d-flex justify-content-between">
                                    {% for i in range(1, 11) %}
                                    <button type="button" class="btn btn-outline-primary focus-rating-btn" 
                                            data-rating="{{ i }}">{{ i }}</button>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="focus-rating" value="5">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Session Notes (Optional)</label>
                                <textarea id="session-notes" class="form-control" rows="3" 
                                          placeholder="What did you accomplish? Any insights?"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="skipFeedback()">Skip</button>
                            <button type="button" class="btn btn-success" onclick="submitSessionFeedback()">
                                Save Session
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Break Timer Modal -->
            <div class="modal fade" id="breakModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-cup-hot me-2"></i>Break Time!
                            </h5>
                        </div>
                        <div class="modal-body text-center">
                            <div class="mb-4">
                                <i class="bi bi-emoji-smile display-1 text-info"></i>
                                <h4 class="mt-3">Time for a well-deserved break!</h4>
                                <p class="text-muted">Relax, stretch, or grab a drink. You've earned it!</p>
                            </div>
                            
                            <div class="break-timer mb-4">
                                <div id="break-timer-display" class="display-3 text-info">5:00</div>
                                <p class="text-muted">Break time remaining</p>
                            </div>
                            
                            <div class="break-suggestions">
                                <h6>Break Suggestions:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check text-success me-2"></i>Stretch your body</li>
                                    <li><i class="bi bi-check text-success me-2"></i>Drink some water</li>
                                    <li><i class="bi bi-check text-success me-2"></i>Take deep breaths</li>
                                    <li><i class="bi bi-check text-success me-2"></i>Look away from screen</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-info" onclick="skipBreak()">Skip Break</button>
                            <button type="button" class="btn btn-success" onclick="startNextSession()">
                                Start Next Session
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timer-circle {
    position: relative;
    display: inline-block;
}

.timer-svg {
    transform: rotate(-90deg);
}

.timer-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.stat-box {
    padding: 1rem;
    border-radius: 0.5rem;
    background-color: #f8f9fa;
}

.focus-rating-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin: 0 2px;
}

.focus-rating-btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.break-suggestions {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.5rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
class PomodoroTimer {
    constructor() {
        this.isRunning = false;
        this.isPaused = false;
        this.currentSession = null;
        this.timeRemaining = 25 * 60; // 25 minutes in seconds
        this.totalTime = 25 * 60;
        this.cyclesCompleted = 0;
        this.totalFocusTime = 0;
        this.pointsEarned = 0;
        
        this.initializeElements();
        this.bindEvents();
        this.loadTodayStats();
    }
    
    initializeElements() {
        this.timerDisplay = document.getElementById('timer-display');
        this.timerStatus = document.getElementById('timer-status');
        this.progressCircle = document.getElementById('progress-circle');
        this.startBtn = document.getElementById('start-btn');
        this.pauseBtn = document.getElementById('pause-btn');
        this.stopBtn = document.getElementById('stop-btn');
        this.configPanel = document.getElementById('config-panel');
        this.subjectSelect = document.getElementById('subject-select');
        this.customSubject = document.getElementById('custom-subject');
        this.workDuration = document.getElementById('work-duration');
    }
    
    bindEvents() {
        this.startBtn.addEventListener('click', () => this.startSession());
        this.pauseBtn.addEventListener('click', () => this.pauseSession());
        this.stopBtn.addEventListener('click', () => this.stopSession());
        
        this.subjectSelect.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                this.customSubject.style.display = 'block';
                this.customSubject.focus();
            } else {
                this.customSubject.style.display = 'none';
            }
        });
        
        this.workDuration.addEventListener('change', (e) => {
            if (!this.isRunning) {
                this.timeRemaining = parseInt(e.target.value) * 60;
                this.totalTime = this.timeRemaining;
                this.updateDisplay();
            }
        });
        
        // Focus rating buttons
        document.querySelectorAll('.focus-rating-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.focus-rating-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('focus-rating').value = e.target.dataset.rating;
            });
        });
    }
    
    startSession() {
        const subject = this.getSelectedSubject();
        if (!subject) {
            alert('Please select a subject first!');
            return;
        }
        
        if (!this.isRunning) {
            // Start new session
            this.isRunning = true;
            this.isPaused = false;
            this.startApiSession(subject);
        } else if (this.isPaused) {
            // Resume paused session
            this.isPaused = false;
        }
        
        this.updateButtons();
        this.configPanel.style.display = 'none';
        this.timerStatus.textContent = 'Focus Time - Stay Concentrated!';
        
        this.timer = setInterval(() => {
            if (!this.isPaused) {
                this.timeRemaining--;
                this.updateDisplay();
                
                if (this.timeRemaining <= 0) {
                    this.completeSession();
                }
            }
        }, 1000);
    }
    
    pauseSession() {
        this.isPaused = true;
        this.timerStatus.textContent = 'Paused - Click Start to Resume';
        this.updateButtons();
    }
    
    stopSession() {
        if (confirm('Are you sure you want to stop the current session?')) {
            this.resetTimer();
        }
    }
    
    completeSession() {
        clearInterval(this.timer);
        this.isRunning = false;
        
        // Show completion modal
        const modal = new bootstrap.Modal(document.getElementById('sessionCompleteModal'));
        modal.show();
        
        // Play completion sound (if available)
        this.playNotificationSound();
        
        // Update stats
        this.cyclesCompleted++;
        this.totalFocusTime += this.totalTime / 3600; // Convert to hours
        this.updateStatsDisplay();
    }
    
    async startApiSession(subject) {
        try {
            const response = await fetch('/api/pomodoro/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subject: subject,
                    duration: this.totalTime / 60
                })
            });
            
            const data = await response.json();
            if (data.success) {
                this.currentSession = data.session_id;
            }
        } catch (error) {
            console.error('Error starting session:', error);
        }
    }
    
    async submitSessionFeedback() {
        const focusRating = document.getElementById('focus-rating').value;
        const notes = document.getElementById('session-notes').value;
        
        try {
            const response = await fetch('/api/pomodoro/complete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: this.currentSession,
                    focus_rating: parseInt(focusRating),
                    notes: notes
                })
            });
            
            const data = await response.json();
            if (data.success) {
                this.pointsEarned += data.points_earned;
                this.updateStatsDisplay();
                
                // Show success message
                this.timerStatus.textContent = `Session saved! +${data.points_earned} points`;
            }
        } catch (error) {
            console.error('Error saving session:', error);
        }
        
        // Close modal and start break
        bootstrap.Modal.getInstance(document.getElementById('sessionCompleteModal')).hide();
        this.startBreak();
    }
    
    startBreak() {
        // Show break modal
        const modal = new bootstrap.Modal(document.getElementById('breakModal'));
        modal.show();
        
        // Start break timer (5 minutes)
        let breakTime = 5 * 60;
        const breakDisplay = document.getElementById('break-timer-display');
        
        const breakTimer = setInterval(() => {
            breakTime--;
            const minutes = Math.floor(breakTime / 60);
            const seconds = breakTime % 60;
            breakDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (breakTime <= 0) {
                clearInterval(breakTimer);
                // Auto-close break modal
                bootstrap.Modal.getInstance(document.getElementById('breakModal')).hide();
                this.resetTimer();
            }
        }, 1000);
    }
    
    resetTimer() {
        clearInterval(this.timer);
        this.isRunning = false;
        this.isPaused = false;
        this.currentSession = null;
        this.timeRemaining = parseInt(this.workDuration.value) * 60;
        this.totalTime = this.timeRemaining;
        
        this.updateDisplay();
        this.updateButtons();
        this.configPanel.style.display = 'block';
        this.timerStatus.textContent = 'Ready to Start';
    }
    
    updateDisplay() {
        const minutes = Math.floor(this.timeRemaining / 60);
        const seconds = this.timeRemaining % 60;
        this.timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Update progress circle
        const progress = (this.totalTime - this.timeRemaining) / this.totalTime;
        const circumference = 2 * Math.PI * 140; // radius = 140
        const offset = circumference - (progress * circumference);
        this.progressCircle.style.strokeDashoffset = offset;
    }
    
    updateButtons() {
        if (this.isRunning && !this.isPaused) {
            this.startBtn.style.display = 'none';
            this.pauseBtn.style.display = 'inline-block';
            this.stopBtn.style.display = 'inline-block';
        } else if (this.isRunning && this.isPaused) {
            this.startBtn.style.display = 'inline-block';
            this.startBtn.innerHTML = '<i class="bi bi-play-fill me-2"></i>Resume';
            this.pauseBtn.style.display = 'none';
            this.stopBtn.style.display = 'inline-block';
        } else {
            this.startBtn.style.display = 'inline-block';
            this.startBtn.innerHTML = '<i class="bi bi-play-fill me-2"></i>Start Session';
            this.pauseBtn.style.display = 'none';
            this.stopBtn.style.display = 'none';
        }
    }
    
    updateStatsDisplay() {
        document.getElementById('cycles-completed').textContent = this.cyclesCompleted;
        document.getElementById('total-focus-time').textContent = `${this.totalFocusTime.toFixed(1)}h`;
        document.getElementById('points-earned').textContent = this.pointsEarned;
    }
    
    getSelectedSubject() {
        if (this.subjectSelect.value === 'custom') {
            return this.customSubject.value.trim();
        }
        return this.subjectSelect.value;
    }
    
    playNotificationSound() {
        // Create audio notification
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
        audio.play().catch(() => {
            // Fallback: show browser notification if audio fails
            if (Notification.permission === 'granted') {
                new Notification('Pomodoro Complete!', {
                    body: 'Great job! Time for a break.',
                    icon: '/static/img/favicon.ico'
                });
            }
        });
    }
    
    async loadTodayStats() {
        try {
            const response = await fetch('/api/user/stats');
            const data = await response.json();
            if (data.success) {
                // Update display with today's stats
                this.updateStatsDisplay();
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
}

// Global functions for modal interactions
function submitSessionFeedback() {
    window.pomodoroTimer.submitSessionFeedback();
}

function skipFeedback() {
    bootstrap.Modal.getInstance(document.getElementById('sessionCompleteModal')).hide();
    window.pomodoroTimer.startBreak();
}

function skipBreak() {
    bootstrap.Modal.getInstance(document.getElementById('breakModal')).hide();
    window.pomodoroTimer.resetTimer();
}

function startNextSession() {
    bootstrap.Modal.getInstance(document.getElementById('breakModal')).hide();
    window.pomodoroTimer.resetTimer();
}

// Initialize timer when page loads
document.addEventListener('DOMContentLoaded', function() {
    window.pomodoroTimer = new PomodoroTimer();
    
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
});
</script>
{% endblock %}